name: Build and Release

on:
  push:
    branches:
      - main
    tags:
      - "v*"
    paths:
      - Jellyfin.Plugin.Stash/**
      - .github/**
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 1.4.0.0)"
        required: true
        type: string
      changelog:
        description: "Changelog for this release"
        required: true
        type: string

env:
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  DOTNET_NOLOGO: true

jobs:
  build-jellyfin:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      checksum: ${{ steps.checksum.outputs.checksum }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Restore dependencies
        run: dotnet restore

      - name: Build Release
        run: dotnet build --configuration Release --no-restore

      - name: Get version from csproj
        id: version
        run: |
          VERSION=$(grep -oP '(?<=<AssemblyVersion>)[^<]+' Jellyfin.Plugin.Stash/Stash.csproj)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected version: $VERSION"

      - name: Prepare artifacts
        run: |
          cd Jellyfin.Plugin.Stash/bin/Release/net9.0
          mv Stash.dll Jellyfin.Plugin.Stash.dll
          mv Stash.pdb Jellyfin.Plugin.Stash.pdb

      - name: Create ZIP
        run: |
          cd Jellyfin.Plugin.Stash/bin/Release/net9.0
          zip -j Jellyfin.Plugin.Stash.zip Jellyfin.Plugin.Stash.dll Jellyfin.Plugin.Stash.pdb

      - name: Calculate checksum
        id: checksum
        run: |
          CHECKSUM=$(md5sum Jellyfin.Plugin.Stash/bin/Release/net9.0/Jellyfin.Plugin.Stash.zip | awk '{print $1}')
          echo "checksum=$CHECKSUM" >> $GITHUB_OUTPUT
          echo "Checksum: $CHECKSUM"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          if-no-files-found: error
          name: Jellyfin
          retention-days: 90
          path: Jellyfin.Plugin.Stash/bin/Release/net9.0/Jellyfin.Plugin.Stash.zip

  build-emby:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Add msbuild to PATH
        uses: microsoft/setup-msbuild@v2

      - name: Build Release
        run: MSBuild -t:Restore,Build -p:RestorePackagesConfig=true -property:Configuration=Release.Emby

      - name: Rename Files
        run: |
          ren Jellyfin.Plugin.Stash/bin/Release.Emby/netstandard2.1/Stash.dll Emby.Plugins.Stash.dll
          ren Jellyfin.Plugin.Stash/bin/Release.Emby/netstandard2.1/Stash.pdb Emby.Plugins.Stash.pdb

      - name: Create ZIP
        uses: vimtor/action-zip@v1.2
        with:
          files: Jellyfin.Plugin.Stash/bin/Release.Emby/netstandard2.1/Emby.Plugins.Stash.dll Jellyfin.Plugin.Stash/bin/Release.Emby/netstandard2.1/Emby.Plugins.Stash.pdb
          dest: Emby.Plugins.Stash.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          if-no-files-found: error
          name: Emby
          retention-days: 90
          path: Emby.Plugins.Stash.zip

  # Development builds on main branch pushes
  deploy-dev:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && !startsWith(github.ref, 'refs/tags/')
    needs: [build-jellyfin, build-emby]
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create development release
        uses: marvinpinto/action-automatic-releases@latest
        with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          automatic_release_tag: "latest"
          prerelease: true
          title: "Development Build"
          files: |
            **/Jellyfin.Plugin.Stash.zip
            **/Emby.Plugins.Stash.zip

  # Versioned releases triggered by tags or workflow_dispatch
  deploy-release:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    needs: [build-jellyfin, build-emby]
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "changelog=${{ github.event.inputs.changelog }}" >> $GITHUB_OUTPUT
          else
            # Extract version from tag (v1.2.3.4 -> 1.2.3.4)
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "changelog=See release notes" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: v${{ steps.version.outputs.version }}
          body: ${{ steps.version.outputs.changelog }}
          draft: false
          prerelease: false
          files: |
            **/Jellyfin.Plugin.Stash.zip
            **/Emby.Plugins.Stash.zip

      - name: Update manifest.json
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          CHANGELOG="${{ steps.version.outputs.changelog }}"
          CHECKSUM="${{ needs.build-jellyfin.outputs.checksum }}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          SOURCE_URL="https://github.com/${{ github.repository }}/releases/download/v${VERSION}/Jellyfin.Plugin.Stash.zip"

          # Use jq to update manifest.json
          jq --arg version "$VERSION" \
             --arg checksum "$CHECKSUM" \
             --arg changelog "$CHANGELOG" \
             --arg timestamp "$TIMESTAMP" \
             --arg sourceUrl "$SOURCE_URL" \
             '.[0].versions = [{
               "version": $version,
               "checksum": $checksum,
               "changelog": $changelog,
               "targetAbi": "10.11.0.0",
               "sourceUrl": $sourceUrl,
               "timestamp": $timestamp
             }] + .[0].versions' manifest.json > manifest.tmp.json

          mv manifest.tmp.json manifest.json

          echo "Updated manifest.json:"
          cat manifest.json

      - name: Commit and push manifest
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add manifest.json
          git commit -m "chore: update manifest for v${{ steps.version.outputs.version }}" || echo "No changes to commit"
          git push origin HEAD:main
