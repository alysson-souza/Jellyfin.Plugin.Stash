<!DOCTYPE html>
<html>
<head>
    <title>Stash</title>
    <style>
        #TestConnection:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        /* Visual grouping for path mapping section */
        .nested-option {
            margin: 1em 0;
            padding: 1em;
            background: rgba(255,255,255,0.03);
            border-radius: 0.25em;
        }
    </style>
</head>
<body>
    <div id="ConfigurationPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-select,emby-checkbox,emby-button">
        <div data-role="content">
            <div class="content-primary">
                <h1>Stash</h1>
                <form id="ConfigForm">
                    <h2>Connection</h2>
                    <div class="fieldDescription">Tell the plugin how to reach your Stash server. The URL should point to the Stash UI/API (for example <code>http://localhost:9999</code>). The API key can be generated in Stash under <em>Settings → Security</em>.</div>
                    <div class="inputContainer">
                        <input id="StashEndpoint" name="StashEndpoint" type="text" is="emby-input" label="Stash Endpoint" />
                        <div class="fieldDescription">Base URL of your Stash instance, including port. Do not include <code>/graphql</code>.</div>
                    </div>
                    <div class="inputContainer">
                        <input id="StashAPIKey" name="StashAPIKey" type="password" is="emby-input" label="Stash API Key" autocomplete="new-password" />
                        <div class="fieldDescription">Used for authenticated GraphQL calls. Leave blank only if your Stash instance allows anonymous access.</div>
                    </div>
                    <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
                        <button id="TestConnection" is="emby-button" type="button" class="raised button-submit emby-button">
                            <span>Test connection</span>
                        </button>
                        <div id="TestStatus" class="fieldDescription"></div>
                    </div>

                    <h2>Scene matching</h2>
                    <div class="selectContainer">
                        <label class="selectLabel" for="MatchingMode">Find scenes in Stash by</label>
                        <select is="emby-select" id="MatchingMode" name="MatchingMode" class="emby-select-withcolor emby-select">
                            <option value="title">Title (search by item name)</option>
                            <option value="filename">Filename (match by file name only)</option>
                            <option value="fullpath">Full path (exact path match)</option>
                        </select>
                        <div class="fieldDescription">
                            <strong>Title:</strong> Searches Stash using the item's name.<br>
                            <strong>Filename:</strong> Matches by the file name without directory, useful when paths differ.<br>
                            <strong>Full path:</strong> Requires the exact file path to match. Use path mapping below if directories differ.
                        </div>
                    </div>
                    <div id="PathMappingContainer" class="nested-option">
                        <h3 style="margin-top:0;">Path mapping</h3>
                        <div class="fieldDescription">Translate Jellyfin paths to Stash paths if they use different mount points.</div>
                        <table style="width:100%; border-collapse:collapse; margin:0.75em 0;">
                            <tr>
                                <td style="width:45%; padding-right:0.5em;">
                                    <input id="PathPrefixJellyfin" name="PathPrefixJellyfin" type="text" is="emby-input" label="Jellyfin prefix" />
                                </td>
                                <td style="width:10%; text-align:center; font-size:1.5em; color:#888; vertical-align:bottom; padding-bottom:0.6em;">→</td>
                                <td style="width:45%; padding-left:0.5em;">
                                    <input id="PathPrefixStash" name="PathPrefixStash" type="text" is="emby-input" label="Stash prefix" />
                                </td>
                            </tr>
                        </table>
                        <div class="fieldDescription">Leave blank if paths are identical. Example: <code>/jellyfin/media/video.mp4</code> → <code>/data/video.mp4</code></div>
                    </div>

                    <h2>Metadata options</h2>
                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label class="emby-checkbox-label">
                            <input id="AddDisambiguation" name="AddDisambiguation" type="checkbox" is="emby-checkbox" />
                            <span>Add disambiguation to performer names</span>
                        </label>
                        <div class="fieldDescription">Appends Stash disambiguation text in parentheses to performer names to avoid collisions.</div>
                    </div>
                    <div class="selectContainer">
                        <label class="selectLabel" for="TagStyle">Tag style</label>
                        <select is="emby-select" id="TagStyle" name="TagStyle" class="emby-select-withcolor emby-select">
                            <option value="Genre">Genres</option>
                            <option value="Tag">Tags</option>
                            <option value="Disabled">Disabled</option>
                        </select>
                        <div class="fieldDescription">Controls how Stash tags are written to Jellyfin items: as genres, as tags, or not at all.</div>
                    </div>

                    <button is="emby-button" type="submit" class="raised button-submit block emby-button">
                        <span>Save</span>
                    </button>
                </form>
            </div>
        </div>
        <script type="text/javascript">
            var pluginConfig = {
                pluginUniqueId: 'fb7a756d-d694-461a-99eb-2458b44f983f'
            };

            function normalizeEndpoint(raw) {
                return (raw || '').replace(/\s+/g, '').replace(/\/*$/, '');
            }

            function setStatus(text) {
                $('#TestStatus').text(text);
            }

            var isTestRunning = false;

            function testConnection() {
                if (isTestRunning) return;

                var endpoint = normalizeEndpoint($('#StashEndpoint').val());
                var apiKey = $('#StashAPIKey').val();
                var $btn = $('#TestConnection');
                var $btnText = $btn.find('span');

                if (!endpoint) {
                    setStatus('Please enter a Stash endpoint first.');
                    return;
                }

                isTestRunning = true;
                $btn.prop('disabled', true);
                $btnText.text('Testing…');
                setStatus('Connecting to Stash server…');

                var params = new URLSearchParams({ endpoint: endpoint });
                if (apiKey) {
                    params.append('apiKey', apiKey);
                }

                var url = ApiClient.getUrl('Plugins/Stash/TestConnection') + '?' + params.toString();

                ApiClient.ajax({
                    url: url,
                    type: 'GET',
                    dataType: 'json'
                }).then(function(response) {
                    var success = response && (response.success === true || response.Success === true);
                    var message = response && (response.message || response.Message);
                    if (success) {
                        setStatus(message || 'Connected!');
                    } else if (message) {
                        setStatus(message);
                    } else {
                        setStatus('Unknown response from server.');
                    }
                    isTestRunning = false;
                    $btn.prop('disabled', false);
                    $btnText.text('Test connection');
                }).catch(function(err) {
                    var msg = 'Connection failed';
                    if (err && err.status === 401) {
                        msg = 'Unauthorized. Please refresh the page.';
                    } else if (err && err.statusText) {
                        msg = 'Error: ' + err.statusText;
                    } else if (err && err.message) {
                        msg = 'Error: ' + err.message;
                    }
                    setStatus(msg);
                    isTestRunning = false;
                    $btn.prop('disabled', false);
                    $btnText.text('Test connection');
                });
            }

            function getMatchingModeFromConfig(config) {
                if (!config.UseFilePath) return 'title';
                if (config.UseFullPathToSearch) return 'fullpath';
                return 'filename';
            }

            function setConfigFromMatchingMode(config, mode) {
                if (mode === 'title') {
                    config.UseFilePath = false;
                    config.UseFullPathToSearch = false;
                } else if (mode === 'filename') {
                    config.UseFilePath = true;
                    config.UseFullPathToSearch = false;
                } else {
                    config.UseFilePath = true;
                    config.UseFullPathToSearch = true;
                }
            }

            function updatePathMappingVisibility() {
                var mode = $('#MatchingMode').val();
                if (mode === 'fullpath') {
                    $('#PathMappingContainer').show();
                } else {
                    $('#PathMappingContainer').hide();
                }
            }

            $('#ConfigurationPage').on('pageshow', function () {
                Dashboard.showLoadingMsg();
                ApiClient.getPluginConfiguration(pluginConfig.pluginUniqueId).then(function (config) {
                    $('#StashEndpoint').val(config.StashEndpoint).change();
                    $('#StashAPIKey').val(config.StashAPIKey).change();
                    $('#MatchingMode').val(getMatchingModeFromConfig(config)).change();
                    $('#PathPrefixJellyfin').val(config.PathPrefixJellyfin || '');
                    $('#PathPrefixStash').val(config.PathPrefixStash || '');
                    $('#AddDisambiguation').prop('checked', config.AddDisambiguation);
                    $('#TagStyle').val(config.TagStyle).change();
                    updatePathMappingVisibility();

                    Dashboard.hideLoadingMsg();
                });
            });

            $('#MatchingMode').on('change', function() {
                updatePathMappingVisibility();
            });

            $('#TestConnection').on('click', function (e) {
                e.preventDefault();
                testConnection();
            });

            $('#ConfigurationPage').on('submit', function () {
                Dashboard.showLoadingMsg();
                ApiClient.getPluginConfiguration(pluginConfig.pluginUniqueId).then(function (config) {
                    config.StashEndpoint = normalizeEndpoint($('#StashEndpoint').val());
                    config.StashAPIKey = $('#StashAPIKey').val();
                    setConfigFromMatchingMode(config, $('#MatchingMode').val());
                    config.PathPrefixJellyfin = $('#PathPrefixJellyfin').val().trim();
                    config.PathPrefixStash = $('#PathPrefixStash').val().trim();
                    config.AddDisambiguation = $('#AddDisambiguation').prop('checked');
                    config.TagStyle = $('#TagStyle').val();

                    ApiClient.updatePluginConfiguration(pluginConfig.pluginUniqueId, config).then(function (result) {
                        Dashboard.processPluginConfigurationUpdateResult(result);
                    });
                });
                return false;
            });
        </script>
    </div>
</body>
</html>

